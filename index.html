<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor de Plagas Forestales CDMX</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    body, html {
      margin: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      display: flex; flex-direction: column;
    }
    #titulo {
      padding: 10px 20px;
      background: #006400;
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
      user-select: none;
    }
    #radioBtn {
      position: absolute;
      top: 100px; left: 10px;
      background-color: #ffffff;
      color: #006400;
      padding: 10px 16px;
      cursor: pointer;
      border: 2px solid #006400;
      border-radius: 6px;
      font-weight: bold;
      z-index: 1000;
      user-select: none;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    #radioBtn:hover {
      background-color: #e6f0ff;
      color: #004d00;
    }
    #radioBtn.active {
      background-color: #c82333;
      color: #fff;
      border-color: #bd2130;
    }
    #radioBtn.active:hover {
      background-color: #a71d2a;
    }
    #map {
      height: 90vh;
      width: 100%;
      position: relative;
      z-index: 0;
    }
  </style>
</head>
<body>
  <div id="titulo">Visor de Plagas Forestales CDMX</div>
  <div id="radioBtn" onclick="toggleRadio()">ðŸŽ¯ Activar Radio</div>
  <div id="map"></div>

  <!-- Turf.js para anÃ¡lisis geoespacial -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // Centrar en CDMX aprox
    const map = L.map('map').setView([19.43, -99.13], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const capasGeojson = [
      { archivo: 'Areas de Atencion Prioritaria 2025.geojson', campo: null, color: '#1f78b4' },
      { archivo: 'Descortezador Junio 2025.geojson', campo: 'Rie_Jun_De', color: '#33a02c' },
      { archivo: 'Plantas Parasitas 2025.geojson', campo: 'Riesg_PP25', color: '#e31a1c' },
      { archivo: 'Riesgo Cactoblastis Cactorum 2025.geojson', campo: 'R_Cacto', color: '#ff7f00' },
      { archivo: 'Riesgo Cactophagus Spinolae 2024.geojson', campo: 'N_Riesgo', color: '#6a3d9a' },
      { archivo: 'Riesgo Defoliadores Junio 2025.geojson', campo: 'Ri_Def_Jun', color: '#b15928' },
      { archivo: 'Riesgo Monarthrum 2024.geojson', campo: 'N_RIESGO', color: '#a6cee3' }
    ];

    const capasControl = {};
    let capasCargadas = {}; // para almacenar las capas geojson

    // Cargar y agregar capas
    function cargarCapas() {
      capasGeojson.forEach(capa => {
        fetch(capa.archivo)
          .then(res => res.json())
          .then(data => {
            const layer = L.geoJSON(data, {
              style: () => ({
                color: capa.color,
                weight: 1,
                fillOpacity: 0.5
              }),
              onEachFeature: function (feature, layer) {
                let popup = `<strong>${capa.archivo.replace('.geojson', '')}</strong>`;
                if (capa.campo && feature.properties[capa.campo] !== undefined) {
                  popup += `<br><strong>Nivel de riesgo:</strong> ${feature.properties[capa.campo]}`;
                }
                layer.bindPopup(popup);
              }
            });
            layer.addTo(map);
            capasControl[capa.archivo.replace('.geojson', '')] = layer;
            capasCargadas[capa.archivo.replace('.geojson', '')] = layer;

            if (!controlCapas) {
              controlCapas = L.control.layers(null, capasControl, { collapsed: false }).addTo(map);
            } else {
              controlCapas.addOverlay(layer, capa.archivo.replace('.geojson', ''));
            }
          })
          .catch(err => console.error('Error al cargar', capa.archivo, err));
      });
    }
    let controlCapas;
    cargarCapas();

    // Radio
    let radioActivo = false;
    let radioCapa = null;
    const radioBtn = document.getElementById('radioBtn');

    function toggleRadio() {
      radioActivo = !radioActivo;
      radioBtn.classList.toggle('active');
      radioBtn.textContent = radioActivo ? 'ðŸ›‘ Cancelar Radio' : 'ðŸŽ¯ Activar Radio';
      if (!radioActivo && radioCapa) {
        map.removeLayer(radioCapa);
        radioCapa = null;
      }
      if (!radioActivo) return;

      map.once('click', function(e) {
        if (radioCapa) {
          map.removeLayer(radioCapa);
          radioCapa = null;
        }
        // Crear cÃ­rculo radio 500m
        radioCapa = L.circle(e.latlng, {
          radius: 500,
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 0.2
        }).addTo(map);

        // Crear polÃ­gono turf del cÃ­rculo
        const center = [e.latlng.lng, e.latlng.lat]; // turf usa [lng, lat]
        const turfCircle = turf.circle(center, 0.5, { units: 'kilometers' }); // radio 0.5 km

        // Buscar polÃ­gonos que intersectan
        let totalEncontrados = 0;
        let resumen = '';

        Object.entries(capasCargadas).forEach(([nombre, layer]) => {
          if (!map.hasLayer(layer)) return; // Solo capas visibles

          let encontradosPorCapa = 0;

          layer.eachLayer(featureLayer => {
            const geojsonFeature = featureLayer.toGeoJSON();
            if (turf.booleanIntersects(turfCircle, geojsonFeature)) {
              encontradosPorCapa++;
              totalEncontrados++;
            }
          });

          if(encontradosPorCapa > 0){
            resumen += `<br>${nombre}: ${encontradosPorCapa} polÃ­gono(s)`;
          }
        });

        const mensaje = totalEncontrados > 0 
          ? `Elementos dentro del radio 500 m: <strong>${totalEncontrados}</strong> ${resumen}`
          : 'No se encontraron elementos dentro del radio de 500 metros.';

        radioCapa.bindPopup(mensaje).openPopup();
      });
    }
  </script>
</body>
</html>
