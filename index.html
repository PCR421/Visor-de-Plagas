<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor de Plagas Forestales</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
    }
    #titulo {
      padding: 10px 20px;
      background: #006400;
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
      user-select: none;
      position: relative;
    }
    #radioBtn, #clearBtn {
      position: absolute;
      top: 50px;
      left: 10px;
      background-color: #ffffff;
      color: #006400;
      padding: 10px 16px;
      cursor: pointer;
      border: 2px solid #006400;
      border-radius: 6px;
      font-weight: bold;
      z-index: 1000;
      user-select: none;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      margin-bottom: 5px;
      display: inline-block;
    }
    #radioBtn:hover, #clearBtn:hover {
      background-color: #e6f0ff;
      color: #004d00;
      border-color: #004d00;
    }
    #radioBtn.active {
      background-color: #c82333;
      color: #fff;
      border-color: #bd2130;
    }
    #radioBtn.active:hover {
      background-color: #a71d2a;
    }
    #map {
      height: 90vh;
      width: 100%;
      position: relative;
      margin-top: 80px;
    }
  </style>
</head>
<body>
  <div id="titulo">
    Visor de Plagas Forestales
    <button id="radioBtn">üéØ Activar Radio</button>
    <button id="clearBtn">üóëÔ∏è Limpiar Radios</button>
  </div>
  <div id="map"></div>

  <!-- Turf.js para an√°lisis espacial -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([19.4, -99.14], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Configuraci√≥n de capas GeoJSON y campo para nivel de riesgo
    const capasGeojson = [
      { archivo: 'Areas de Atencion Prioritaria 2025.geojson', campo: null },
      { archivo: 'Descortezador Junio 2025.geojson', campo: 'Rie_Jun_De' },
      { archivo: 'Plantas Parasitas 2025.geojson', campo: 'Riesg_PP25' },
      { archivo: 'Riesgo Cactoblastis Cactorum 2025.geojson', campo: 'R_Cacto' },
      { archivo: 'Riesgo Cactophagus Spinolae 2024.geojson', campo: 'N_Riesgo' },
      { archivo: 'Riesgo Defoliadores Junio 2025.geojson', campo: 'Ri_Def_Jun' },
      { archivo: 'Riesgo Monarthrum 2024.geojson', campo: 'N_RIESGO' }
    ];

    const colores = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0'];

    const capasControl = {};
    const capasCargadas = {}; // Para guardar layers y hacer an√°lisis espacial
    let radios = [];
    let radioActivo = false;

    // Cargar capas
    capasGeojson.forEach((capa, i) => {
      fetch(capa.archivo)
        .then(res => res.json())
        .then(data => {
          const layer = L.geoJSON(data, {
            style: {
              color: colores[i],
              weight: 1,
              fillOpacity: 0.4
            },
            onEachFeature: function(feature, layer) {
              let popup = `<strong>${capa.archivo.replace('.geojson', '')}</strong>`;
              if (capa.campo && feature.properties[capa.campo] !== undefined) {
                popup += `<br><strong>Nivel de riesgo:</strong> ${feature.properties[capa.campo]}`;
              }
              layer.bindPopup(popup);
            }
          }).addTo(map);

          const nombreCapa = capa.archivo.replace('.geojson', '');
          capasControl[nombreCapa] = layer;
          capasCargadas[nombreCapa] = layer;

          // A√±adir control capas (se actualiza cada vez, pero est√° bien para pocos)
          L.control.layers(null, capasControl, { collapsed: false }).addTo(map);
        })
        .catch(err => console.error('Error al cargar', capa.archivo, err));
    });

    // Botones
    const radioBtn = document.getElementById('radioBtn');
    const clearBtn = document.getElementById('clearBtn');

    radioBtn.addEventListener('click', () => {
      radioActivo = !radioActivo;
      radioBtn.classList.toggle('active');
      radioBtn.textContent = radioActivo ? 'üõë Desactivar Radio' : 'üéØ Activar Radio';
    });

    clearBtn.addEventListener('click', () => {
      radios.forEach(c => map.removeLayer(c));
      radios = [];
    });

    // Evento click para agregar radios y analizar intersecci√≥n
    map.on('click', function(e) {
      if (!radioActivo) return;

      // Crear c√≠rculo radio 500 metros
      const nuevoRadio = L.circle(e.latlng, {
        radius: 500,
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.2
      }).addTo(map);

      radios.push(nuevoRadio);

      // Crear c√≠rculo turf para an√°lisis espacial (lng, lat)
      const center = [e.latlng.lng, e.latlng.lat];
      const turfCircle = turf.circle(center, 0.5, { units: 'kilometers' });

      let totalEncontrados = 0;
      let resumen = '';
      let nivelesPorCapa = {};

      Object.entries(capasCargadas).forEach(([nombre, layer]) => {
        if (!map.hasLayer(layer)) return; // Solo capas visibles

        let encontradosPorCapa = 0;
        let nivelesRiesgo = [];

        layer.eachLayer(featureLayer => {
          const geojsonFeature = featureLayer.toGeoJSON();
          if (turf.booleanIntersects(turfCircle, geojsonFeature)) {
            encontradosPorCapa++;
            totalEncontrados++;

            // Extraer nivel de riesgo
            const capaInfo = capasGeojson.find(c => c.archivo.replace('.geojson', '') === nombre);
            if (capaInfo && capaInfo.campo) {
              const nivel = featureLayer.feature.properties[capaInfo.campo];
              if (nivel) nivelesRiesgo.push(nivel);
            }
          }
        });

        if (encontradosPorCapa > 0) {
          resumen += `<br><strong>${nombre}:</strong> ${encontradosPorCapa} pol√≠gono(s)`;

          if (nivelesRiesgo.length > 0) {
            let contador = {};
            nivelesRiesgo.forEach(n => contador[n] = (contador[n] || 0) + 1);
            let nivelMasComun = Object.entries(contador).sort((a,b) => b[1] - a[1])[0][0];
            resumen += ` (Nivel de riesgo frecuente: ${nivelMasComun})`;
          }
        }
      });

      const mensaje = totalEncontrados > 0 
        ? `Elementos dentro del radio 500 m: <strong>${totalEncontrados}</strong>${resumen}`
        : 'No se encontraron elementos dentro del radio de 500 metros.';

      nuevoRadio.bindPopup(mensaje).openPopup();
    });
  </script>
</body>
</html>
